name: ðŸ§ª Test GigaChat Hashtags

on:
  workflow_dispatch:  # Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install urllib3

      - name: Test GigaChat
        env:
          GIGACHAT_API_KEY: ${{ secrets.GIGACHAT_API_KEY }}
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Python-Ñ„Ð°Ð¹Ð»
          cat > test_gigachat.py << 'EOF'
          import os
          import base64
          import json
          import uuid
          import urllib3
          import time

          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          API_KEY = os.getenv('GIGACHAT_API_KEY')
          if not API_KEY:
              raise Exception("âŒ GIGACHAT_API_KEY Ð½Ðµ Ð·Ð°Ð´Ð°Ð½")

          def get_token():
              decoded = base64.b64decode(API_KEY.strip()).decode("utf-8")
              client_id, client_secret = decoded.split(":", 1)
              credentials = f"{client_id}:{client_secret}"
              basic_token = base64.b64encode(credentials.encode("ascii")).decode("ascii")

              url = "https://ngw.devices.sberbank.ru:9443/api/v2/oauth"
              body = b"scope=GIGACHAT_API_PERS"
              headers = {
                  "Authorization": f"Basic {basic_token}",
                  "Content-Type": "application/x-www-form-urlencoded",
                  "RqUID": str(uuid.uuid4()),
                  "Accept": "application/json"
              }

              http = urllib3.PoolManager(cert_reqs="CERT_NONE")
              resp = http.request("POST", url, body=body, headers=headers)
              if resp.status == 200:
                  data = json.loads(resp.data)
                  print("âœ… Ð¢Ð¾ÐºÐµÐ½ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½")
                  return data["access_token"]
              else:
                  raise Exception(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚Ð¾ÐºÐµÐ½Ð°: {resp.status} {resp.data.decode()}")

          def call_gigachat(token, text):
              url = "https://gigachat.devices.sberbank.ru/api/v1/chat/completions"
              headers = {
                  "Authorization": f"Bearer {token}",
                  "Content-Type": "application/json"
              }
              body = {
                  "model": "GigaChat-2-Max",
                  "messages": [
                      {"role": "system", "content": "Ð¢Ñ‹ â€” Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð¿Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÑŽ Ñ…ÐµÑˆÑ‚ÐµÐ³Ð¾Ð² Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Telegram-ÐºÐ°Ð½Ð°Ð»Ðµ."},
                      {"role": "user", "content": f'''Ð¢Ñ‹ â€” Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð¿Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÑŽ Ñ…ÐµÑˆÑ‚ÐµÐ³Ð¾Ð² Ð´Ð»Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Telegram-ÐºÐ°Ð½Ð°Ð»Ðµ.
ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ð² Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°, Ñ‚Ñ‹ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð½Ð°Ð±Ð¾Ñ€ Ñ€ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½Ñ‹Ñ… Ñ…ÐµÑˆÑ‚ÐµÐ³Ð¾Ð² Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ.
Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ…ÐµÑˆÑ‚ÐµÐ³Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¾Ð±ÐµÐ», Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ Ñ Ñ€ÐµÑˆÑ‘Ñ‚ÐºÐ¸.
ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð¸:
- ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð±Ñ€ÐµÐ½Ð´Ð° (ÐµÑÐ»Ð¸ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ "Tommy Hilfiger", Ñ‚Ð¾ #tommyhilfiger).
- ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ Ñ‚Ð¾Ð²Ð°Ñ€Ð° (ÐµÑÐ»Ð¸ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ "ÑÑƒÐ¼ÐºÐ°" Ð¸Ð»Ð¸ "Ñ€ÑŽÐºÐ·Ð°Ðº", Ñ‚Ð¾ #ÑÑƒÐ¼ÐºÐ°).
- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ñ‚Ð¾Ð²Ð°Ñ€Ð° (#Ð²_Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸, ÐµÑÐ»Ð¸ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ "Ð’ ÐÐÐ›Ð˜Ð§Ð˜Ð˜").
- ÐÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ñ, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ…ÐµÑˆÑ‚ÐµÐ³Ð¸.
- ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ…ÐµÑˆÑ‚ÐµÐ³Ð¸ Ð¿Ñ€Ð¾ Ð²Ð¸Ð´ÐµÐ¾, YouTube, Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸.

Ð¢ÐµÐºÑÑ‚ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:
{text}'''}
                  ],
                  "temperature": 0.3,
                  "max_tokens": 60
              }

              http = urllib3.PoolManager(cert_reqs="CERT_NONE")
              resp = http.request("POST", url, body=json.dumps(body).encode(), headers=headers)
              if resp.status == 200:
                  result = json.loads(resp.data)
                  raw = result["choices"][0]["message"]["content"].strip()
                  print(f"ðŸ” Ð¡Ñ‹Ñ€Ð¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ñ‚ GigaChat:\n{raw}")
                  hashtags = " ".join([tag for tag in raw.split() if tag.startswith('#')])
                  print(f"âœ… Ð¥ÐµÑˆÑ‚ÐµÐ³Ð¸: {hashtags or '#Ñ‚Ð¾Ð²Ð°Ñ€'}")
                  return hashtags or "#Ñ‚Ð¾Ð²Ð°Ñ€"
              else:
                  err = resp.data.decode()
                  print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° GigaChat: {resp.status} {err}")
                  return "#Ñ‚Ð¾Ð²Ð°Ñ€"

          # --- Ð¢ÐµÑÑ‚ Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ð¸Ð· Ð²Ð°ÑˆÐµÐ³Ð¾ ÐºÐ°Ð½Ð°Ð»Ð° ---
          test_text = "Karl lagerfeld ðŸ˜Ž ðŸ± 13300Ð + ðŸšš"
          print(f"Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐºÑÑ‚: {test_text}")
          token = get_token()
          hashtags = call_gigachat(token, test_text)
          print(f"\nðŸ Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: {hashtags}")
          EOF

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Python-ÑÐºÑ€Ð¸Ð¿Ñ‚
          python3 test_gigachat.py
